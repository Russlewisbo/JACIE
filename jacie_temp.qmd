---
title: "JACIE Cumulative Outcomes Report"
subtitle: "2025 Annual Report - Rolling Cohort Analysis"
author: "HSCT Program Quality Indicators"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
format:
  html:
    toc: true
    toc-depth: 3
    toc-location: left
    code-fold: true
    theme: cosmo
    embed-resources: true
    fig-width: 10
    fig-height: 6
execute:
  echo: false
  warning: false
  message: false
---

::: {.callout-note}
## AI-Generated Report with Rolling Cohort Methodology


```{r setup}
library(tidyverse)
library(readxl)
library(knitr)
library(kableExtra)
library(lubridate)
library(ggplot2)

# Load and prepare data
transplant_data <- read_excel("Calcoli_RDD_2025.xlsx")

# Data preparation
transplant_data_prepared <- transplant_data |>
  mutate(
    hsct_date = `HSCT date`,
    hsct_year = year(hsct_date),
    death_date_clean = case_when(
      `Death date` == "-" ~ NA,
      TRUE ~ as.Date(as.numeric(`Death date`), origin = "1899-12-30")
    ),
    days_to_event = as.numeric(difftime(`Date of last follow up`, hsct_date, units = "days")),
    death = ifelse(grepl("^dead", `State at last follow up`), 1, 0),
    disease_status_binary = case_when(
      `Disease status at HSCT` == "Complete Remission" ~ "Complete Remission",
      TRUE ~ "Not in Complete Remission"
    ),
    donor_type_main = case_when(
      `Donor type` == "Related HLA-identical" ~ "Sibling HLA-identical",
      `Donor type` == "Related Haploidentical" ~ "Haploidentical",
      `Donor type` == "URD HLA-identical" ~ "MUD",
      `Donor type` == "URD HLA-mismatched" ~ "MMUD"
    ),
    death_cause = case_when(
      death == 0 ~ "Alive",
      grepl("disease", `State at last follow up`) ~ "Relapse",
      grepl("GVHD", `State at last follow up`) ~ "GVHD",
      grepl("infection", `State at last follow up`) ~ "Infection",
      grepl("other cause", `State at last follow up`) ~ "Other",
      TRUE ~ "Unknown"
    ),
    # Use death_type column directly from Excel file (TRM, NRM, RRM)
    # Don't recalculate it
    death_type = death_type,
    acute_gvhd_grade_ii_iv = case_when(
      !is.na(`acute GVHD global grade`) & `acute GVHD global grade` %in% c(2, 3, 4) ~ 1,
      TRUE ~ 0
    ),
    chronic_gvhd_any = ifelse(`chronic GVHD` == "sì", 1, 0),
    chronic_gvhd_mod_severe = case_when(
      !is.na(`chronic GVHD global grade`) & 
        `chronic GVHD global grade` %in% c("moderata", "severa") ~ 1,
      TRUE ~ 0
    )
  )

report_year <- 2025
```

# Executive Summary

## Reporting Period and Methodology

**Reporting Period:** Calendar Year 2025 (January 1 - December 31, 2025)

**Methodology:** Cumulative Rolling Cohort Analysis following JACIE Italian guidelines

::: {.callout-important}
## Cumulative Rolling Cohort Methodology

This report uses **cumulative rolling cohort analysis** as specified by JACIE Italy. For each quarter and timepoint, we calculate outcomes for ALL patients who reached that milestone during the cumulative period from Q1 through that quarter.

**Key principle**: Results should be **cumulative and monotonically increasing** - the percentage at 100 days should be ≥ 30 days, and 365 days should be ≥ 100 days, since we're looking at the same patients plus those who reach later milestones.

**Example for Q4 2025:**

- **30-day outcome**: All patients whose 30-day milestone fell between **Jan 1 - Nov 30, 2025** (transplanted Sep 1, 2024 - Oct 31, 2025)
- **100-day outcome**: All patients whose 100-day milestone fell between **Jan 1 - Sep 30, 2025** (transplanted Jul 1, 2024 - Sep 30, 2025)
- **365-day outcome**: All patients whose 365-day milestone fell between **Jan 1 (2024) - Dec 31, 2025** (transplanted Jan 1, 2024 - Dec 31, 2025)

This provides mature outcome data since patients have had sufficient follow-up time.
:::

```{r rolling-functions}
# Cumulative rolling cohort selection for annual reporting
# Based on JACIE Italian quarterly methodology, cumulative through Q4

# For 30-day outcomes: Milestone dates from Jan 1 - Nov 30, 2025
# HSCT dates: Sep 1, 2024 - Oct 31, 2025
select_cohort_30d <- function(data, year = 2025) {
  milestone_start <- as.Date(paste0(year - 1, "-09-01"))  # Sep 1 previous year
  milestone_end <- as.Date(paste0(year, "-11-30"))        # Nov 30 current year
  
  cohort <- data |>
    mutate(milestone_30d = hsct_date + days(30)) |>
    filter(
      milestone_30d >= milestone_start,
      milestone_30d <= milestone_end,
      days_to_event >= 30 | death == 1
    )
  
  return(cohort)
}

# For 100-day outcomes: Milestone dates from Jan 1 - Sep 30, 2025
# HSCT dates: Jul 1, 2024 - Sep 30, 2025
select_cohort_100d <- function(data, year = 2025) {
  milestone_start <- as.Date(paste0(year - 1, "-07-01"))  # Jul 1 previous year
  milestone_end <- as.Date(paste0(year, "-09-30"))        # Sep 30 current year
  
  cohort <- data |>
    mutate(milestone_100d = hsct_date + days(100)) |>
    filter(
      milestone_100d >= milestone_start,
      milestone_100d <= milestone_end,
      days_to_event >= 100 | death == 1
    )
  
  return(cohort)
}

# For 365-day outcomes: Milestone dates from Jan 1, 2024 - Dec 31, 2025
# HSCT dates: Jan 1, 2024 - Dec 31, 2024
select_cohort_365d <- function(data, year = 2025) {
  milestone_start <- as.Date(paste0(year - 1, "-01-01"))  # Jan 1 previous year
  milestone_end <- as.Date(paste0(year, "-12-31"))        # Dec 31 current year
  
  cohort <- data |>
    mutate(milestone_365d = hsct_date + days(365)) |>
    filter(
      milestone_365d >= milestone_start,
      milestone_365d <= milestone_end,
      days_to_event >= 365 | death == 1
    )
  
  return(cohort)
}

# Mortality calculation for a cohort
calc_mortality <- function(cohort, days) {
  if (nrow(cohort) == 0) {
    return(tibble(timepoint = paste0(days, " days"), n_cohort = 0,
                  n_events = NA_integer_, pct = NA_real_))
  }
  
  # Count all deaths with a death_type (TRM, NRM, or RRM) within the timeframe
  n_deaths <- sum(!is.na(cohort$death_type) & cohort$days_to_event <= days, na.rm = TRUE)
  
  tibble(
    timepoint = paste0(days, " days"),
    n_cohort = nrow(cohort),
    n_events = n_deaths,
    pct = round(100 * n_deaths / nrow(cohort), 1)
  )
}

# NRM calculation
calc_nrm <- function(cohort, days) {
  if (nrow(cohort) == 0) {
    return(tibble(timepoint = paste0(days, " days"), n_cohort = 0,
                  n_events = NA_integer_, pct = NA_real_))
  }
  
  n_nrm <- sum(cohort$death_type == "NRM" & cohort$days_to_event <= days, na.rm = TRUE)
  
  tibble(
    timepoint = paste0(days, " days"),
    n_cohort = nrow(cohort),
    n_events = n_nrm,
    pct = round(100 * n_nrm / nrow(cohort), 1)
  )
}

# Relapse mortality calculation (RRM - Relapse-Related Mortality)
calc_relapse <- function(cohort, days) {
  if (nrow(cohort) == 0) {
    return(tibble(timepoint = paste0(days, " days"), n_cohort = 0,
                  n_events = NA_integer_, pct = NA_real_))
  }
  
  n_relapse <- sum(cohort$death_type == "RRM" & cohort$days_to_event <= days, na.rm = TRUE)
  
  tibble(
    timepoint = paste0(days, " days"),
    n_cohort = nrow(cohort),
    n_events = n_relapse,
    pct = round(100 * n_relapse / nrow(cohort), 1)
  )
}

# TRM calculation
calc_trm <- function(cohort, days) {
  if (nrow(cohort) == 0) {
    return(tibble(timepoint = paste0(days, " days"), n_cohort = 0,
                  n_events = NA_integer_, pct = NA_real_))
  }
  
  n_trm <- sum(cohort$death_type == "TRM" & cohort$days_to_event <= days, na.rm = TRUE)
  
  tibble(
    timepoint = paste0(days, " days"),
    n_cohort = nrow(cohort),
    n_events = n_trm,
    pct = round(100 * n_trm / nrow(cohort), 1)
  )
}

# Acute GVHD calculation (100 days)
calc_agvhd <- function(cohort) {
  if (nrow(cohort) == 0) {
    return(tibble(n_cohort = 0, n_events = NA_integer_, pct = NA_real_))
  }
  
  n_agvhd <- sum(cohort$acute_gvhd_grade_ii_iv == 1)
  
  tibble(
    n_cohort = nrow(cohort),
    n_events = n_agvhd,
    pct = round(100 * n_agvhd / nrow(cohort), 1)
  )
}

# Chronic GVHD calculation (365 days)
calc_cgvhd <- function(cohort, severity = "any") {
  if (nrow(cohort) == 0) {
    return(tibble(severity = severity, n_cohort = 0,
                  n_events = NA_integer_, pct = NA_real_))
  }
  
  n_cgvhd <- if (severity == "mod_severe") {
    sum(cohort$chronic_gvhd_mod_severe == 1, na.rm = TRUE)
  } else {
    sum(cohort$chronic_gvhd_any == 1, na.rm = TRUE)
  }
  
  tibble(
    severity = severity,
    n_cohort = nrow(cohort),
    n_events = n_cgvhd,
    pct = round(100 * n_cgvhd / nrow(cohort), 1)
  )
}
```

```{r calculate-results}
# Select cohorts for each timepoint
cohort_30d <- select_cohort_30d(transplant_data_prepared, report_year)
cohort_100d <- select_cohort_100d(transplant_data_prepared, report_year)
cohort_365d <- select_cohort_365d(transplant_data_prepared, report_year)

# Calculate overall mortality at each timepoint
overall_mort <- bind_rows(
  calc_mortality(cohort_30d, 30),
  calc_mortality(cohort_100d, 100),
  calc_mortality(cohort_365d, 365)
)

# Calculate NRM at each timepoint
nrm_overall <- bind_rows(
  calc_nrm(cohort_30d, 30),
  calc_nrm(cohort_100d, 100),
  calc_nrm(cohort_365d, 365)
)

# Calculate relapse mortality at each timepoint
relapse_overall <- bind_rows(
  calc_relapse(cohort_30d, 30),
  calc_relapse(cohort_100d, 100),
  calc_relapse(cohort_365d, 365)
)

# Calculate TRM at each timepoint
trm_overall <- bind_rows(
  calc_trm(cohort_30d, 30),
  calc_trm(cohort_100d, 100),
  calc_trm(cohort_365d, 365)
)

# By disease status
cr_data <- transplant_data_prepared |> filter(disease_status_binary == "Complete Remission")
not_cr_data <- transplant_data_prepared |> filter(disease_status_binary == "Not in Complete Remission")

# CR cohorts
cohort_30d_cr <- select_cohort_30d(cr_data, report_year)
cohort_100d_cr <- select_cohort_100d(cr_data, report_year)
cohort_365d_cr <- select_cohort_365d(cr_data, report_year)

mort_cr <- bind_rows(
  calc_mortality(cohort_30d_cr, 30),
  calc_mortality(cohort_100d_cr, 100),
  calc_mortality(cohort_365d_cr, 365)
) |> mutate(group = "Complete Remission")

nrm_cr <- bind_rows(
  calc_nrm(cohort_30d_cr, 30),
  calc_nrm(cohort_100d_cr, 100),
  calc_nrm(cohort_365d_cr, 365)
) |> mutate(group = "Complete Remission")

relapse_cr <- bind_rows(
  calc_relapse(cohort_30d_cr, 30),
  calc_relapse(cohort_100d_cr, 100),
  calc_relapse(cohort_365d_cr, 365)
) |> mutate(group = "Complete Remission")

trm_cr <- bind_rows(
  calc_trm(cohort_30d_cr, 30),
  calc_trm(cohort_100d_cr, 100),
  calc_trm(cohort_365d_cr, 365)
) |> mutate(group = "Complete Remission")

# Not CR cohorts
cohort_30d_not_cr <- select_cohort_30d(not_cr_data, report_year)
cohort_100d_not_cr <- select_cohort_100d(not_cr_data, report_year)
cohort_365d_not_cr <- select_cohort_365d(not_cr_data, report_year)

mort_not_cr <- bind_rows(
  calc_mortality(cohort_30d_not_cr, 30),
  calc_mortality(cohort_100d_not_cr, 100),
  calc_mortality(cohort_365d_not_cr, 365)
) |> mutate(group = "Not in Complete Remission")

nrm_not_cr <- bind_rows(
  calc_nrm(cohort_30d_not_cr, 30),
  calc_nrm(cohort_100d_not_cr, 100),
  calc_nrm(cohort_365d_not_cr, 365)
) |> mutate(group = "Not in Complete Remission")

relapse_not_cr <- bind_rows(
  calc_relapse(cohort_30d_not_cr, 30),
  calc_relapse(cohort_100d_not_cr, 100),
  calc_relapse(cohort_365d_not_cr, 365)
) |> mutate(group = "Not in Complete Remission")

trm_not_cr <- bind_rows(
  calc_trm(cohort_30d_not_cr, 30),
  calc_trm(cohort_100d_not_cr, 100),
  calc_trm(cohort_365d_not_cr, 365)
) |> mutate(group = "Not in Complete Remission")

# GVHD by donor type
major_donors <- c("Sibling HLA-identical", "Haploidentical", "MUD", "MMUD")
agvhd_overall <- calc_agvhd(cohort_100d)

agvhd_by_donor <- tibble()
for (donor in major_donors) {
  donor_data <- transplant_data_prepared |> filter(donor_type_main == donor)
  cohort_100d_donor <- select_cohort_100d(donor_data, report_year)
  result <- calc_agvhd(cohort_100d_donor) |> mutate(donor = donor)
  agvhd_by_donor <- bind_rows(agvhd_by_donor, result)
}

# Chronic GVHD
cgvhd_any <- bind_rows(
  calc_cgvhd(cohort_365d, "any") |> mutate(severity = "Any"),
  calc_cgvhd(cohort_365d, "mod_severe") |> mutate(severity = "Moderate-Severe")
)
```

## Key Findings Summary

### Overall Mortality (All Patients) - Cumulative Rolling Cohort

```{r mortality-summary}
kable(overall_mort |>
  mutate(display = paste0(pct, "% (", n_events, "/", n_cohort, ")")) |>
  select(Timepoint = timepoint, `Cohort Size` = n_cohort, 
         Deaths = n_events, `Mortality Rate` = display),
      caption = "Table 1: Overall Cumulative Mortality - Rolling Cohort Analysis") |>
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) |>
  row_spec(0, bold = TRUE, background = "#3498DB", color = "white")
```

::: {.callout-note}
## Understanding Cohort Sizes

Note that cohort sizes **differ** across timepoints because each represents a different observation period:

- **30-day cohort**: Patients whose 30-day milestone occurred Jan 1 - Nov 30, 2025 (N = `r overall_mort$n_cohort[1]`)
- **100-day cohort**: Patients whose 100-day milestone occurred Jan 1 - Sep 30, 2025 (N = `r overall_mort$n_cohort[2]`)
- **365-day cohort**: Patients whose 365-day milestone occurred Jan 1, 2024 - Dec 31, 2025 (N = `r overall_mort$n_cohort[3]`)

The mortality percentages are cumulative and should generally increase at later timepoints (30d ≤ 100d ≤ 365d) as cumulative mortality accrues over time.
:::

### Mortality by Cause: TRM, NRM, and RRM

```{r mortality-cause}
cause_summary <- tibble(
  Timepoint = c("30 days", "100 days", "365 days"),
  `Overall Mortality` = paste0(overall_mort$pct, "% (", overall_mort$n_events, "/", overall_mort$n_cohort, ")"),
  `TRM` = paste0(trm_overall$pct, "% (", trm_overall$n_events, "/", trm_overall$n_cohort, ")"),
  `NRM` = paste0(nrm_overall$pct, "% (", nrm_overall$n_events, "/", nrm_overall$n_cohort, ")"),
  `RRM` = paste0(relapse_overall$pct, "% (", relapse_overall$n_events, "/", relapse_overall$n_cohort, ")")
)

kable(cause_summary,
      caption = "Table 2: Cumulative Mortality Breakdown by Cause (Overall = TRM + NRM + RRM)") |>
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) |>
  row_spec(0, bold = TRUE, background = "#E74C3C", color = "white")
```

::: {.callout-tip}
## Understanding Mortality Categories

**TRM (Treatment-Related Mortality)** includes deaths directly related to the transplant procedure and immediate complications.

**NRM (Non-Relapse Mortality)** includes deaths from:

- Infection
- GVHD complications  
- Organ toxicity
- Other transplant-related complications (not classified as TRM)

**RRM (Relapse-Related Mortality)** includes deaths from disease progression or relapse.

At 365 days: **TRM = `r trm_overall$pct[3]`%**, **NRM = `r nrm_overall$pct[3]`%**, and **RRM = `r relapse_overall$pct[3]`%**
:::

---

# Detailed Results

## 1. Overall Mortality Analysis

### 1.1 Mortality at Key Timepoints by Cause

```{r mortality-plot, fig.width=10, fig.height=6}
plot_data <- bind_rows(
  overall_mort |> mutate(outcome = "Overall Mortality"),
  trm_overall |> mutate(outcome = "TRM"),
  nrm_overall |> mutate(outcome = "NRM"),
  relapse_overall |> mutate(outcome = "RRM")
) |>
  mutate(
    timepoint = factor(timepoint, levels = c("30 days", "100 days", "365 days")),
    outcome = factor(outcome, levels = c("Overall Mortality", "TRM", "NRM", "RRM"))
  )

ggplot(plot_data, aes(x = timepoint, y = pct, fill = outcome)) +
  geom_col(position = "dodge", width = 0.7) +
  geom_text(aes(label = paste0(pct, "%\n(", n_events, "/", n_cohort, ")")),
            position = position_dodge(width = 0.7),
            vjust = -0.5, size = 3, fontface = "bold") +
  scale_fill_manual(values = c("Overall Mortality" = "#E74C3C", 
                                "TRM" = "#9B59B6",
                                "NRM" = "#E67E22",
                                "RRM" = "#3498DB")) +
  labs(title = "Figure 1: Cumulative Mortality Outcomes by Timepoint",
       subtitle = "Cumulative Rolling Cohort Analysis - 2025 (TRM, NRM, RRM)",
       x = "Time Post-HSCT", y = "Cumulative Percentage (%)",
       fill = "Outcome Type") +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(face = "bold", size = 16),
        plot.subtitle = element_text(size = 12, color = "gray40"),
        legend.position = "top",
        panel.grid.minor = element_blank()) +
  ylim(0, max(plot_data$pct, na.rm = TRUE) * 1.3)
```

### 1.2 Mortality by Disease Status at Transplant

```{r mort-by-disease}
kable(bind_rows(mort_cr, mort_not_cr) |>
  mutate(display = paste0(pct, "% (", n_events, "/", n_cohort, ")")) |>
  select(Group = group, Timepoint = timepoint, 
         `Cohort Size` = n_cohort, Deaths = n_events, `Mortality Rate` = display),
      caption = "Table 3: Cumulative Mortality by Disease Status at HSCT") |>
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) |>
  pack_rows("Complete Remission", 1, 3, label_row_css = "background-color: #27AE60; color: white;") |>
  pack_rows("Not in Complete Remission", 4, 6, label_row_css = "background-color: #E74C3C; color: white;")
```

::: {.callout-warning}
## Disease Status Impact

**Complete Remission patients**: 365-day mortality = `r mort_cr$pct[3]`%  
**Not in Complete Remission**: 365-day mortality = `r mort_not_cr$pct[3]`%

Achieving complete remission before transplant is associated with better outcomes.
:::

---

## 2. Non-Relapse Mortality (NRM)

### 2.1 NRM by Timepoint

```{r nrm-overall-table}
kable(nrm_overall |>
  mutate(display = paste0(pct, "% (", n_events, "/", n_cohort, ")")) |>
  select(Timepoint = timepoint, `Cohort Size` = n_cohort, 
         `NRM Events` = n_events, `NRM Rate` = display),
      caption = "Table 4: Cumulative Non-Relapse Mortality (NRM)") |>
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) |>
  row_spec(0, bold = TRUE, background = "#E67E22", color = "white")
```

::: {.callout-important}
## NRM Analysis

**Definition**: NRM represents deaths from transplant-related complications, NOT disease progression.

- **30-day NRM**: `r nrm_overall$pct[1]`% - Early transplant complications
- **100-day NRM**: `r nrm_overall$pct[2]`% - Standard early NRM window  
- **365-day NRM**: `r nrm_overall$pct[3]`% - Cumulative NRM including late complications

```{r nrm-prop, results='asis'}
if (!is.na(overall_mort$n_events[3]) && overall_mort$n_events[3] > 0) {
  nrm_prop <- round(100 * nrm_overall$n_events[3] / overall_mort$n_events[3], 0)
  cat(paste0("NRM accounts for **", nrm_prop, "%** of all deaths at 365 days."))
}
```
:::

### 2.2 NRM by Disease Status

```{r nrm-by-disease}
kable(bind_rows(
  nrm_overall |> mutate(group = "Overall"),
  nrm_cr, nrm_not_cr
) |>
  mutate(display = paste0(pct, "% (", n_events, "/", n_cohort, ")")) |>
  select(Group = group, Timepoint = timepoint, 
         `Cohort Size` = n_cohort, `NRM Events` = n_events, `NRM Rate` = display),
      caption = "Table 5: Non-Relapse Mortality by Disease Status") |>
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) |>
  pack_rows("Overall", 1, 3, label_row_css = "background-color: #95A5A6; color: white;") |>
  pack_rows("Complete Remission", 4, 6, label_row_css = "background-color: #27AE60; color: white;") |>
  pack_rows("Not in Complete Remission", 7, 9, label_row_css = "background-color: #E74C3C; color: white;")
```

### 2.3 NRM Causes Breakdown

```{r nrm-causes}
nrm_deaths <- cohort_365d |>
  filter(death == 1, death_type == "NRM", days_to_event <= 365)

if (nrow(nrm_deaths) > 0) {
  nrm_causes <- nrm_deaths |>
    count(death_cause) |>
    arrange(desc(n)) |>
    mutate(percentage = round(100 * n / sum(n), 1),
           display = paste0(n, " (", percentage, "%)")) |>
    select(`Cause of NRM` = death_cause, `N Events` = n, `Percentage` = display)
  
  kable(nrm_causes,
        caption = "Table 6: Breakdown of NRM by Specific Cause (365-day cohort)") |>
    kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) |>
    row_spec(0, bold = TRUE, background = "#D35400", color = "white")
} else {
  cat("No NRM events in the 365-day rolling cohort.")
}
```

---

## 2.4 TRM (Treatment-Related Mortality)

### 2.4.1 TRM by Timepoint

```{r trm-overall-table}
kable(trm_overall |>
  mutate(display = paste0(pct, "% (", n_events, "/", n_cohort, ")")) |>
  select(Timepoint = timepoint, `Cohort Size` = n_cohort, 
         `TRM Events` = n_events, `TRM Rate` = display),
      caption = "Table 6A: Cumulative Treatment-Related Mortality (TRM)") |>
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) |>
  row_spec(0, bold = TRUE, background = "#9B59B6", color = "white")
```

::: {.callout-important}
## TRM Analysis

**Definition**: TRM represents deaths specifically from treatment-related complications (distinct from NRM and relapse).

- **30-day TRM**: `r trm_overall$pct[1]`%
- **100-day TRM**: `r trm_overall$pct[2]`%
- **365-day TRM**: `r trm_overall$pct[3]`%

```{r trm-prop, results='asis'}
if (!is.na(overall_mort$n_events[3]) && overall_mort$n_events[3] > 0) {
  trm_prop <- round(100 * trm_overall$n_events[3] / overall_mort$n_events[3], 0)
  cat(paste0("TRM accounts for **", trm_prop, "%** of all deaths at 365 days."))
}
```
:::

### 2.4.2 TRM by Disease Status

```{r trm-by-disease}
kable(bind_rows(
  trm_overall |> mutate(group = "Overall"),
  trm_cr, trm_not_cr
) |>
  mutate(display = paste0(pct, "% (", n_events, "/", n_cohort, ")")) |>
  select(Group = group, Timepoint = timepoint, 
         `Cohort Size` = n_cohort, `TRM Events` = n_events, `TRM Rate` = display),
      caption = "Table 6B: Treatment-Related Mortality by Disease Status") |>
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) |>
  pack_rows("Overall", 1, 3, label_row_css = "background-color: #95A5A6; color: white;") |>
  pack_rows("Complete Remission", 4, 6, label_row_css = "background-color: #27AE60; color: white;") |>
  pack_rows("Not in Complete Remission", 7, 9, label_row_css = "background-color: #E74C3C; color: white;")
```

---

## 3. Relapse-Related Mortality (RRM)

```{r relapse-overall-table}
kable(relapse_overall |>
  mutate(display = paste0(pct, "% (", n_events, "/", n_cohort, ")")) |>
  select(Timepoint = timepoint, `Cohort Size` = n_cohort, 
         `RRM Deaths` = n_events, `RRM Rate` = display),
      caption = "Table 7: Cumulative Relapse-Related Mortality (RRM)") |>
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) |>
  row_spec(0, bold = TRUE, background = "#3498DB", color = "white")
```

### 3.1 RRM by Disease Status

```{r relapse-by-disease}
kable(bind_rows(
  relapse_overall |> mutate(group = "Overall"),
  relapse_cr, relapse_not_cr
) |>
  mutate(display = paste0(pct, "% (", n_events, "/", n_cohort, ")")) |>
  select(Group = group, Timepoint = timepoint, 
         `Cohort Size` = n_cohort, `RRM Deaths` = n_events, `RRM Rate` = display),
      caption = "Table 8: Relapse-Related Mortality (RRM) by Disease Status") |>
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) |>
  pack_rows("Overall", 1, 3) |>
  pack_rows("Complete Remission", 4, 6) |>
  pack_rows("Not in Complete Remission", 7, 9)
```

::: {.callout-note}
## RRM Summary

- **365-day RRM**: `r relapse_overall$pct[3]`%
```{r relapse-prop, results='asis'}
if (!is.na(overall_mort$n_events[3]) && overall_mort$n_events[3] > 0) {
  relapse_prop <- round(100 * relapse_overall$n_events[3] / overall_mort$n_events[3], 0)
  cat(paste0("- RRM accounts for **", relapse_prop, "%** of all deaths at 365 days\n"))
}
```
- Not in CR patients show higher RRM (`r relapse_not_cr$pct[3]`%) vs CR patients (`r relapse_cr$pct[3]`%)
:::

```{r late-rrm-check, results='asis'}
# Check for late RRM deaths (after 365 days)
late_rrm <- cohort_365d |>
  filter(death_type == "RRM" & days_to_event > 365)

if (nrow(late_rrm) > 0) {
  cat("\n::: {.callout-warning}\n")
  cat("## Late Relapse Deaths (After 365 Days)\n\n")
  cat("**Important Note:** The 365-day rolling cohort includes **", nrow(cohort_365d), " patients** whose 365-day milestone fell during the reporting period. Of these:\n\n")
  cat("- **", relapse_overall$n_events[3], " patients** died from relapse **within 365 days** post-HSCT (included in 365-day RRM rate above)\n")
  cat("- **", nrow(late_rrm), " additional patient(s)** died from relapse **after 365 days** post-HSCT:\n\n")
  
  for (i in 1:nrow(late_rrm)) {
    cat("  - Patient ", late_rrm$`Patient Code`[i], ": Death at day **", late_rrm$days_to_event[i], "** (", 
        late_rrm$days_to_event[i] - 365, " days after 365-day milestone)\n", sep="")
  }
  
  cat("\n**These late deaths are correctly EXCLUDED from the 365-day mortality analysis** as they occurred beyond the 365-day timepoint. They would be captured in longer-term follow-up analyses (e.g., 2-year or 3-year mortality).\n")
  cat(":::\n\n")
}
```

---

## 4. GVHD Outcomes

### 4.1 Acute GVHD Grade II-IV (100 days)

```{r agvhd-table}
kable(tibble(
  Group = c("Overall", agvhd_by_donor$donor),
  `Cohort Size` = c(agvhd_overall$n_cohort, agvhd_by_donor$n_cohort),
  Events = c(agvhd_overall$n_events, agvhd_by_donor$n_events),
  `Cumulative Incidence` = paste0(c(agvhd_overall$pct, agvhd_by_donor$pct), "%")
),
      caption = "Table 9: Acute GVHD Grade II-IV by Donor Type (100 days)") |>
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) |>
  row_spec(1, bold = TRUE, background = "#9B59B6", color = "white")
```

*Report generated `r format(Sys.Date(), "%B %d, %Y")` using cumulative rolling cohort methodology per JACIE Italian guidelines*

*TRM = Treatment-Related Mortality; NRM = Non-Relapse Mortality; RRM = Relapse-Related Mortality*
